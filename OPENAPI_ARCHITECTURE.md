# OpenAPI架构设计图

本文档提供OpenAPI实施后的系统架构视图和数据流说明。

---

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        外部用户/客户端                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │  Web前端     │  │  Mobile App  │  │  第三方系统   │               │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘               │
│         │                 │                 │                        │
└─────────┼─────────────────┼─────────────────┼────────────────────────┘
          │                 │                 │
          │   HTTP/JSON     │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Swagger UI 交互界面                              │
│                  http://localhost:8080/swagger/                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  • 在线API文档                                                   │ │
│  │  • 交互式测试                                                    │ │
│  │  • 请求/响应示例                                                 │ │
│  │  • Schema定义                                                    │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
          │
          │   读取
          ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      OpenAPI文档 (docs/)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │   docs.go        │  │ swagger.json     │  │  swagger.yaml    │  │
│  │  (Go嵌入)        │  │ (JSON格式)       │  │  (YAML格式)      │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│         ▲                      │                      │              │
│         │                      └──────────┬───────────┘              │
│    swag init                              │                          │
│         │                                 │ 可导出                   │
│         │                                 ▼                          │
└─────────┼─────────────────────────────────────────────────────────┐ │
          │                     ┌──────────────────────┐             │ │
          │                     │  SDK生成工具         │             │ │
          │                     │  • TypeScript        │             │ │
          │                     │  • Python            │             │ │
          │                     │  • Java              │             │ │
          │                     └──────────────────────┘             │ │
          │                                                           │ │
┌─────────┴───────────────────────────────────────────────────────────┘ │
│                      应用服务层 (Gin Framework)                         │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                         main.go                                │   │
│  │  • Swagger注释定义 (@title, @version, @host, @BasePath)       │   │
│  │  • Swagger UI路由配置                                          │   │
│  │  • API分组路由注册                                             │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                              │                                        │
│                              ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                      API Handler层 (api/)                      │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  │   │
│  │  │ supply_chain.go│  │   models.go    │  │   (其他)       │  │   │
│  │  │ • 带Swagger注释│  │ • 请求模型     │  │                │  │   │
│  │  │ • @Summary     │  │ • 响应模型     │  │                │  │   │
│  │  │ • @Tags        │  │ • 数据Schema   │  │                │  │   │
│  │  │ • @Param       │  │ • 验证规则     │  │                │  │   │
│  │  │ • @Success     │  │ • 示例数据     │  │                │  │   │
│  │  │ • @Router      │  │                │  │                │  │   │
│  │  └────────────────┘  └────────────────┘  └────────────────┘  │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                              │                                        │
│                              ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                    Service业务层 (service/)                    │   │
│  │  • 调用Fabric Gateway                                          │   │
│  │  • 业务逻辑处理                                                 │   │
│  │  • 数据转换                                                     │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                              │                                        │
└──────────────────────────────┼────────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Fabric Gateway层 (pkg/fabric/)                    │
│  • 多组织连接管理 (Org1/Org2/Org3)                                   │
│  • 身份验证                                                           │
│  • 交易提交                                                           │
│  • 查询执行                                                           │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  Hyperledger Fabric Network                          │
│  ┌──────────┐        ┌──────────┐        ┌──────────┐              │
│  │  Org1    │        │  Org2    │        │  Org3    │              │
│  │  (OEM)   │        │(Manufac.)│        │(Carrier) │              │
│  └──────────┘        └──────────┘        └──────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、OpenAPI文档生成流程

```
┌──────────────────────────────────────────────────────────────┐
│  开发阶段：编写代码和注释                                       │
└──────────────────────────────────────────────────────────────┘
    │
    │  Step 1: 在main.go中定义API总体信息
    ▼
┌──────────────────────────────────────────────────────────────┐
│  // @title           汽配供应链管理系统 API                     │
│  // @version         1.0                                      │
│  // @description     基于Hyperledger Fabric...               │
│  // @host            localhost:8080                          │
│  // @BasePath        /api                                    │
└──────────────────────────────────────────────────────────────┘
    │
    │  Step 2: 定义数据模型 (models.go)
    ▼
┌──────────────────────────────────────────────────────────────┐
│  type CreateOrderRequest struct {                            │
│      ID   string `json:"id" example:"ORDER001"`              │
│      ...                                                     │
│  }                                                           │
└──────────────────────────────────────────────────────────────┘
    │
    │  Step 3: 为Handler添加Swagger注释
    ▼
┌──────────────────────────────────────────────────────────────┐
│  // CreateOrder godoc                                        │
│  // @Summary      创建订单                                   │
│  // @Tags         OEM                                        │
│  // @Param        request  body  CreateOrderRequest  true   │
│  // @Success      200  {object}  utils.Response             │
│  // @Router       /oem/order/create [post]                  │
│  func (h *SupplyChainHandler) CreateOrder(...)              │
└──────────────────────────────────────────────────────────────┘
    │
    │  Step 4: 运行swag命令生成文档
    ▼
┌──────────────────────────────────────────────────────────────┐
│  $ cd application/server                                     │
│  $ swag init                                                 │
└──────────────────────────────────────────────────────────────┘
    │
    │  Swag工具解析
    ▼
┌──────────────────────────────────────────────────────────────┐
│  Swag工具处理流程：                                           │
│  1. 扫描main.go中的@标注                                      │
│  2. 扫描所有Handler方法的godoc注释                            │
│  3. 解析数据模型的struct定义                                  │
│  4. 构建完整的OpenAPI schema                                 │
│  5. 生成docs.go/swagger.json/swagger.yaml                   │
└──────────────────────────────────────────────────────────────┘
    │
    │  生成输出
    ▼
┌──────────────────────────────────────────────────────────────┐
│  docs/                                                       │
│  ├── docs.go          (Go代码嵌入，import到main.go)          │
│  ├── swagger.json     (OpenAPI JSON格式)                     │
│  └── swagger.yaml     (OpenAPI YAML格式，人类可读)           │
└──────────────────────────────────────────────────────────────┘
    │
    │  Step 5: 启动应用
    ▼
┌──────────────────────────────────────────────────────────────┐
│  $ go run main.go                                            │
│  服务器启动于 :8080                                           │
│  Swagger文档: http://localhost:8080/swagger/index.html       │
└──────────────────────────────────────────────────────────────┘
    │
    │  用户访问
    ▼
┌──────────────────────────────────────────────────────────────┐
│  浏览器访问Swagger UI                                         │
│  • 查看所有API端点                                            │
│  • 查看请求/响应格式                                          │
│  • 在线测试API                                               │
│  • 下载OpenAPI文档                                           │
└──────────────────────────────────────────────────────────────┘
```

---

## 三、API分组架构

```
                        /api (BasePath)
                          │
        ┌─────────────────┼─────────────────┬──────────────┐
        │                 │                 │              │
     /oem            /manufacturer       /carrier      /platform
    (Org1)              (Org2)           (Org3)        (Org3监管)
        │                 │                 │              │
        │                 │                 │              │
    ┌───┴───┐         ┌───┴───┐         ┌───┴───┐        │
    │       │         │       │         │       │        │
POST create  │     PUT accept │     POST pickup │     GET list
    │        │         │       │         │       │        │
PUT receive  │     PUT status │     PUT location│        │
    │        │         │       │         │       │        │
GET :id      │     GET list   │     GET :id     │        │
    │        │                 │         │       │        │
GET list     │                 │     GET list    │        │
             │                 │                 │        │
    ┌────────┴────────┬────────┴────────┬────────┴────────┴─────────┐
    │                 │                 │                            │
 订单生命周期        生产流程          物流跟踪                    监管视图
 • 创建订单          • 接受订单        • 货物取件                  • 全局查看
 • 确认收货          • 更新状态        • 位置上报                  • 监管审计
 • 查询订单          • 查询列表        • 查询物流                  • 数据统计
 • 订单列表                            • 订单列表
```

---

## 四、数据模型关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          核心数据模型                                 │
└─────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────┐
│          Order (订单)           │
├────────────────────────────────┤
│ • id: string                   │
│ • oemId: string               │◄───────────────┐
│ • manufacturerId: string      │                │
│ • items: []OrderItem          │────┐           │
│ • status: string              │    │           │
│ • createdAt: timestamp        │    │           │
│ • updatedAt: timestamp        │    │           │
│ • acceptedAt: timestamp       │    │           │ 一对多
│ • producedAt: timestamp       │    │           │
│ • deliveredAt: timestamp      │    │           │
└────────────────────────────────┘    │           │
            │                         │           │
            │ 一对一                   │           │
            ▼                         │           │
┌────────────────────────────────┐    │           │
│      Shipment (物流单)          │    │           │
├────────────────────────────────┤    │           │
│ • id: string                   │    │           │
│ • orderId: string             │────┘           │
│ • carrierId: string           │                │
│ • status: string              │                │
│ • locations: []Location       │────┐           │
│ • pickupAt: timestamp         │    │           │
│ • updatedAt: timestamp        │    │           │
└────────────────────────────────┘    │           │
                                      │           │
                                      │ 一对多     │
                                      ▼           │
┌────────────────────────────────┐                │
│  ShipmentLocation (位置记录)    │                │
├────────────────────────────────┤                │
│ • location: string            │                │
│ • timestamp: timestamp        │                │
└────────────────────────────────┘                │
                                                  │
                                                  │
┌────────────────────────────────┐                │
│      OrderItem (订单项)         │                │
├────────────────────────────────┤                │
│ • partNumber: string          │◄───────────────┘
│ • partName: string            │
│ • quantity: int               │
│ • unitPrice: float            │
│ • specification: string       │
└────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                       请求/响应包装模型                               │
└─────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────┐
│   CreateOrderRequest (请求)     │
├────────────────────────────────┤
│ • id: string                   │
│ • manufacturerId: string      │
│ • items: []OrderItem          │
└────────────────────────────────┘

┌────────────────────────────────┐
│  UpdateStatusRequest (请求)     │
├────────────────────────────────┤
│ • status: string              │
└────────────────────────────────┘

┌────────────────────────────────┐
│  PickupGoodsRequest (请求)      │
├────────────────────────────────┤
│ • orderId: string             │
│ • shipmentId: string          │
└────────────────────────────────┘

┌────────────────────────────────┐
│ UpdateLocationRequest (请求)    │
├────────────────────────────────┤
│ • location: string            │
└────────────────────────────────┘

┌────────────────────────────────┐
│  OrderListResponse (响应)       │
├────────────────────────────────┤
│ • orders: []Order             │
│ • bookmark: string            │
└────────────────────────────────┘

┌────────────────────────────────┐
│     Response (统一响应)         │
├────────────────────────────────┤
│ • code: int                   │
│ • message: string             │
│ • data: any                   │
└────────────────────────────────┘
```

---

## 五、订单状态流转图

```
┌──────────────────────────────────────────────────────────────────┐
│                        订单完整生命周期                            │
└──────────────────────────────────────────────────────────────────┘

      [OEM]              [Manufacturer]        [Carrier]        [OEM]
        │                      │                    │             │
        │ POST /oem/order/create                   │             │
        │ ─────────────────────────────────────────►             │
        │                      │                    │             │
        ▼                      │                    │             │
  ┌──────────┐                │                    │             │
  │ Created  │                │                    │             │
  └──────────┘                │                    │             │
        │                     │                    │             │
        │                     │ PUT /manufacturer/order/:id/accept
        │                     │◄───────────────────┤             │
        │                     │                    │             │
        │                     ▼                    │             │
        │               ┌──────────┐               │             │
        │               │ Accepted │               │             │
        │               └──────────┘               │             │
        │                     │                    │             │
        │                     │ PUT /manufacturer/order/:id/status
        │                     │ {status: "InProduction"}         │
        │                     ▼                    │             │
        │               ┌──────────────┐           │             │
        │               │InProduction  │           │             │
        │               └──────────────┘           │             │
        │                     │                    │             │
        │                     │ PUT /manufacturer/order/:id/status
        │                     │ {status: "Produced"}             │
        │                     ▼                    │             │
        │               ┌──────────┐               │             │
        │               │ Produced │               │             │
        │               └──────────┘               │             │
        │                     │                    │             │
        │                     │              POST /carrier/shipment/pickup
        │                     │                    │◄────────────┤
        │                     │                    │             │
        │                     │                    ▼             │
        │                     │              ┌──────────┐        │
        │                     │              │ PickedUp │        │
        │                     │              └──────────┘        │
        │                     │                    │             │
        │                     │              PUT /carrier/shipment/:id/location
        │                     │                    │             │
        │                     │                    ▼             │
        │                     │              ┌──────────┐        │
        │                     │              │InTransit │        │
        │                     │              └──────────┘        │
        │                     │                    │             │
        │                     │                    │   PUT /oem/order/:id/receive
        │                     │                    │             │◄──┤
        │                     │                    │             │
        │                     │                    │             ▼
        │                     │                    │       ┌──────────┐
        │                     │                    │       │Delivered │
        │                     │                    │       └──────────┘
        │                     │                    │             │
        ▼                     ▼                    ▼             ▼
   (查询订单)             (查询订单)           (查询物流)    (查询订单)
 GET /oem/order/:id  GET /manufacturer/  GET /carrier/  GET /oem/order/:id
 GET /oem/order/list     order/list      shipment/:id   
                                         GET /carrier/
                                            order/list
```

---

## 六、Swagger注释映射关系

```
┌──────────────────────────────────────────────────────────────────┐
│  Swagger注释             →   OpenAPI文档元素                      │
├──────────────────────────────────────────────────────────────────┤
│  @title                 →   info.title                          │
│  @version               →   info.version                        │
│  @description           →   info.description                    │
│  @contact.name          →   info.contact.name                   │
│  @license.name          →   info.license.name                   │
│  @host                  →   servers[0].url (host部分)           │
│  @BasePath              →   servers[0].url (path部分)           │
│  @tag.name              →   tags[].name                         │
│  @tag.description       →   tags[].description                  │
│  @securityDefinitions   →   components.securitySchemes          │
│                                                                  │
│  // FunctionName godoc  →   (触发解析此函数)                     │
│  @Summary               →   paths[path][method].summary         │
│  @Description           →   paths[path][method].description     │
│  @Tags                  →   paths[path][method].tags            │
│  @Accept                →   paths[path][method].consumes        │
│  @Produce               →   paths[path][method].produces        │
│  @Param                 →   paths[path][method].parameters[]    │
│  @Success               →   paths[path][method].responses[200]  │
│  @Failure               →   paths[path][method].responses[4xx]  │
│  @Router                →   paths定义 + method                  │
│  @Security              →   paths[path][method].security        │
│                                                                  │
│  struct定义             →   components.schemas                  │
│  json tag               →   schema.properties[name]             │
│  example tag            →   schema.properties[name].example     │
│  binding tag            →   schema.required[]                   │
│  minimum/maximum        →   schema.properties[name].minimum     │
│  enums tag              →   schema.properties[name].enum        │
└──────────────────────────────────────────────────────────────────┘
```

---

## 七、工具链集成图

```
┌──────────────────────────────────────────────────────────────────┐
│                      OpenAPI文档中心                              │
│                                                                   │
│        ┌────────────────────────────────┐                        │
│        │     swagger.json/yaml          │                        │
│        │  (OpenAPI 3.0 Specification)   │                        │
│        └────────────┬───────────────────┘                        │
│                     │                                             │
└─────────────────────┼─────────────────────────────────────────────┘
                      │
          ┌───────────┼───────────┐
          │           │           │
          ▼           ▼           ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ Swagger  │ │ Postman  │ │  Redoc   │
    │    UI    │ │          │ │          │
    └──────────┘ └──────────┘ └──────────┘
    在线测试      导入测试集     美化文档
          │           │           │
          └───────────┼───────────┘
                      │
          ┌───────────┼───────────┐
          │           │           │
          ▼           ▼           ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │swagger-  │ │  API     │ │Spectral  │
    │ codegen  │ │ Gateway  │ │          │
    └──────────┘ └──────────┘ └──────────┘
    SDK生成       路由配置      文档校验
          │           │           │
          ▼           ▼           ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │TypeScript│ │   Kong   │ │  质量    │
    │  Python  │ │ Traefik  │ │  报告    │
    │   Java   │ │          │ │          │
    └──────────┘ └──────────┘ └──────────┘
```

---

## 八、开发工作流集成

```
┌──────────────────────────────────────────────────────────────────┐
│                       开发者工作流                                 │
└──────────────────────────────────────────────────────────────────┘

  开发新API
      │
      ▼
┌──────────────┐
│ 1.定义模型   │  →  api/models.go
└──────────────┘     type XXXRequest struct {...}
      │
      ▼
┌──────────────┐
│2.实现Handler │  →  api/supply_chain.go
└──────────────┘     func (h *Handler) XXX(...)
      │
      ▼
┌──────────────┐
│3.添加Swagger │  →  在Handler上方添加注释
│  注释        │     // XXX godoc
└──────────────┘     // @Summary ...
      │
      ▼
┌──────────────┐
│4.生成文档    │  →  $ swag init
└──────────────┘     生成docs/
      │
      ▼
┌──────────────┐
│5.本地测试    │  →  $ go run main.go
└──────────────┘     访问 /swagger/index.html
      │
      ▼
┌──────────────┐
│6.提交代码    │  →  git add .
└──────────────┘     git commit -m "feat: add XXX API"
      │              git push
      ▼
┌──────────────────────────────────────────────────────────────┐
│                      CI/CD Pipeline                           │
├──────────────────────────────────────────────────────────────┤
│  1. 代码检查 (lint)                                           │
│  2. 运行测试 (test)                                           │
│  3. 验证Swagger文档 (swag init + swagger-cli validate)        │
│  4. 构建Docker镜像                                            │
│  5. 部署到环境                                                │
│  6. 发布文档到文档站点                                         │
└──────────────────────────────────────────────────────────────┘
      │
      ▼
  生产环境就绪
```

---

## 九、安全架构

```
┌──────────────────────────────────────────────────────────────────┐
│                         安全层设计                                 │
└──────────────────────────────────────────────────────────────────┘

外部请求
    │
    │ HTTPS/TLS
    ▼
┌──────────────┐
│ API Gateway  │  ← 可选：Kong/Traefik
│ (可选)       │    • Rate Limiting
└──────────────┘    • IP Whitelist
    │               • JWT验证
    │
    ▼
┌──────────────────────────────────────────────────────────────────┐
│                      Gin应用层                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  中间件链                                                   │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
│  │  │  CORS    │→ │  Auth    │→ │RequestID │→ │  Logger  │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │  │
│  └────────────────────────────────────────────────────────────┘  │
│                              │                                    │
│                              ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  组织身份验证 (X-Org-ID Header)                             │  │
│  │  • org1: OEM权限检查                                        │  │
│  │  • org2: Manufacturer权限检查                               │  │
│  │  • org3: Carrier/Platform权限检查                           │  │
│  └────────────────────────────────────────────────────────────┘  │
│                              │                                    │
└──────────────────────────────┼────────────────────────────────────┘
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                    Fabric身份层                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  基于MSP的身份验证                                          │  │
│  │  • X.509证书                                               │  │
│  │  • 私钥签名                                                 │  │
│  │  • 组织MSP ID                                              │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                        Fabric Network
                     (链上ACL + Endorsement)
```

---

## 十、监控和可观测性

```
┌──────────────────────────────────────────────────────────────────┐
│                      OpenAPI + 监控集成                            │
└──────────────────────────────────────────────────────────────────┘

  API调用
      │
      ▼
┌──────────────┐
│  Gin Handler │
└──────────────┘
      │
      ├──────────────────────┐
      │                      │
      ▼                      ▼
┌──────────────┐      ┌──────────────┐
│ 业务Metrics  │      │  Access Log  │
│ • 请求数      │      │ • 请求时间    │
│ • 响应时间    │      │ • 用户信息    │
│ • 错误率      │      │ • 响应码      │
│ • 状态码分布  │      │ • 请求体      │
└──────────────┘      └──────────────┘
      │                      │
      ▼                      ▼
┌──────────────┐      ┌──────────────┐
│ Prometheus   │      │ ELK Stack    │
│ • Grafana    │      │ • Kibana     │
└──────────────┘      └──────────────┘
      │                      │
      └──────────┬───────────┘
                 │
                 ▼
        ┌────────────────┐
        │  Alert Manager │
        │  • API异常告警 │
        │  • 性能下降告警│
        │  • 错误率告警  │
        └────────────────┘

OpenAPI文档的价值：
• 每个endpoint的标准化名称 → 指标标签
• @Tags分组 → 监控Dashboard分组
• 响应码定义 → 告警规则配置
```

---

## 总结

本架构设计展示了OpenAPI在汽配供应链系统中的完整集成方案：

1. **文档生成**：通过swag工具从代码注释自动生成
2. **API分组**：按业务角色清晰组织（OEM/Manufacturer/Carrier/Platform）
3. **数据流转**：订单从创建到交付的完整生命周期
4. **工具集成**：支持SDK生成、API网关、文档发布等
5. **安全设计**：多层身份验证和权限控制
6. **可观测性**：与监控告警系统集成

这个架构既满足当前的文档需求，又为未来的扩展留有充分空间。

---

**文档版本**: v1.0  
**创建日期**: 2024-12-23
